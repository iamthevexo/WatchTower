<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatchTower</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, orderBy, deleteDoc, getDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6HpLfsK56BmvJk9cHp7QQZ7nDD2ezL24",
            authDomain: "vyronixsportfolio.firebaseapp.com",
            databaseURL: "https://vyronixsportfolio-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "vyronixsportfolio",
            storageBucket: "vyronixsportfolio.firebasestorage.app",
            messagingSenderId: "395085884274",
            appId: "1:395085884274:web:fec51059b0b31e4e334beb",
            measurementId: "G-MRZK70HHNH"
        };

        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Vue Application ---
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // State
                const user = ref(null);
                const loading = ref(true);
                const currentView = ref('auth'); // auth, home, social, chat, profile, settings
                const activeTab = ref('towatch'); // towatch, watched
                
                // Data Models
                const newItem = ref({ title: '', type: 'Series', link: '', notes: '' });
                const myWatchlist = ref([]);
                const socialPosts = ref([]);
                const newPost = ref('');
                
                // Chat / Groups
                const myGroups = ref([]);
                const activeGroup = ref(null);
                const groupMessages = ref([]);
                const newGroupName = ref('');
                const newMessage = ref('');
                const groupJoinId = ref('');

                // Profile & Sharing
                const viewProfileId = ref(null);
                const viewedUserProfile = ref(null);
                const viewedUserList = ref([]);

                // Settings
                const appSettings = ref({
                    notifications: true,
                    compactMode: false
                });

                // --- Auth Functions ---
                const loginAnon = () => {
                    signInAnonymously(auth).catch((error) => alert(error.message));
                };

                const loginGoogle = () => {
                    const provider = new GoogleAuthProvider();
                    signInWithPopup(auth, provider).catch((error) => alert(error.message));
                };

                const logout = () => {
                    signOut(auth);
                    currentView.value = 'auth';
                    user.value = null;
                };

                // --- Database Listeners ---
                const initListeners = (uid) => {
                    // 1. Listen to My Watchlist
                    const q = query(collection(db, "watchlists"), where("uid", "==", uid));
                    onSnapshot(q, (snapshot) => {
                        myWatchlist.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    // 2. Listen to Social Feed (Global Suggestions)
                    const qPost = query(collection(db, "posts"), orderBy("timestamp", "desc"));
                    onSnapshot(qPost, (snapshot) => {
                        socialPosts.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    // 3. Listen to My Groups
                    const qGroups = query(collection(db, "groups"), where("members", "array-contains", uid));
                    onSnapshot(qGroups, (snapshot) => {
                        myGroups.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                };

                // --- Watchlist Logic ---
                const addItem = async () => {
                    if (!newItem.value.title) return;
                    await addDoc(collection(db, "watchlists"), {
                        uid: user.value.uid,
                        title: newItem.value.title,
                        type: newItem.value.type,
                        status: 'towatch', // or watched
                        timestamp: Date.now()
                    });
                    newItem.value.title = '';
                };

                const toggleStatus = async (item) => {
                    const newStatus = item.status === 'towatch' ? 'watched' : 'towatch';
                    const itemRef = doc(db, "watchlists", item.id);
                    await updateDoc(itemRef, { status: newStatus });
                };

                const deleteItem = async (id) => {
                    if(confirm("Remove this item?")) {
                        await deleteDoc(doc(db, "watchlists", id));
                    }
                };

                // --- Social Logic ---
                const postSuggestion = async () => {
                    if (!newPost.value) return;
                    await addDoc(collection(db, "posts"), {
                        uid: user.value.uid,
                        author: user.value.displayName || 'Anonymous',
                        content: newPost.value,
                        likes: [],
                        timestamp: Date.now()
                    });
                    newPost.value = '';
                };

                const likePost = async (post) => {
                    const postRef = doc(db, "posts", post.id);
                    const uid = user.value.uid;
                    if (post.likes.includes(uid)) {
                        await updateDoc(postRef, { likes: arrayRemove(uid) });
                    } else {
                        await updateDoc(postRef, { likes: arrayUnion(uid) });
                    }
                };

                // --- Group/Chat Logic ---
                const createGroup = async () => {
                    if (!newGroupName.value) return;
                    await addDoc(collection(db, "groups"), {
                        name: newGroupName.value,
                        members: [user.value.uid],
                        admin: user.value.uid,
                        key: Math.random().toString(36).substring(7) // Simple key for display
                    });
                    newGroupName.value = '';
                };

                const joinGroup = async () => {
                    if(!groupJoinId.value) return;
                    // In a real app we'd verify the ID exists first
                    try {
                        const groupRef = doc(db, "groups", groupJoinId.value);
                        await updateDoc(groupRef, { members: arrayUnion(user.value.uid) });
                        alert("Joined!");
                        groupJoinId.value = '';
                    } catch(e) { alert("Group not found or error joining"); }
                };

                const enterGroup = (group) => {
                    activeGroup.value = group;
                    currentView.value = 'chat_room';
                    
                    // Listen to messages
                    const qMsgs = query(collection(db, `groups/${group.id}/messages`), orderBy("timestamp", "asc"));
                    onSnapshot(qMsgs, (snapshot) => {
                        groupMessages.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                };

                const sendMessage = async () => {
                    if (!newMessage.value) return;
                    await addDoc(collection(db, `groups/${activeGroup.value.id}/messages`), {
                        uid: user.value.uid,
                        author: user.value.displayName || 'Anon',
                        text: newMessage.value,
                        timestamp: Date.now()
                    });
                    newMessage.value = '';
                };

                // --- Sharing Logic ---
                const copyProfileLink = () => {
                    const url = `${window.location.origin}${window.location.pathname}?uid=${user.value.uid}`;
                    navigator.clipboard.writeText(url);
                    alert("Profile link copied to clipboard!");
                };

                const loadSharedProfile = async (uid) => {
                    loading.value = true;
                    // Get User items
                    const q = query(collection(db, "watchlists"), where("uid", "==", uid));
                    const snapshot = await getFirestore(app); // Just triggering init, logic below
                    // Note: In Firestore web SDK, simple query suffices
                    // We need a way to fetch once for shared profile
                    // For simplicity, we assume if URL param exists, we load that view
                };

                // --- Lifecycle ---
                onMounted(() => {
                    onAuthStateChanged(auth, async (currentUser) => {
                        user.value = currentUser;
                        loading.value = false;
                        if (user.value) {
                            // Save/Update User Profile in DB
                            const userRef = doc(db, "users", user.value.uid);
                            await setDoc(userRef, {
                                email: user.value.email,
                                displayName: user.value.displayName || 'Anonymous',
                                lastSeen: Date.now()
                            }, { merge: true });

                            initListeners(user.value.uid);
                            
                            // Check for shared URL
                            const urlParams = new URLSearchParams(window.location.search);
                            const sharedUid = urlParams.get('uid');
                            if(sharedUid && sharedUid !== user.value.uid) {
                                // Logic to view someone else's profile could go here
                                // For now, we stick to the dashboard
                            }
                            currentView.value = 'home';
                        } else {
                            currentView.value = 'auth';
                        }
                    });
                });

                // Computed
                const filteredList = computed(() => {
                    return myWatchlist.value.filter(item => item.status === activeTab.value);
                });

                const counts = computed(() => {
                    return {
                        watched: myWatchlist.value.filter(i => i.status === 'watched').length,
                        towatch: myWatchlist.value.filter(i => i.status === 'towatch').length
                    };
                });

                return {
                    user, loading, currentView, activeTab,
                    newItem, filteredList, addItem, toggleStatus, deleteItem,
                    loginAnon, loginGoogle, logout,
                    socialPosts, newPost, postSuggestion, likePost,
                    myGroups, activeGroup, createGroup, joinGroup, enterGroup, groupMessages, sendMessage, newGroupName, newMessage, groupJoinId,
                    counts, copyProfileLink, appSettings
                };
            }
        }).mount('#app');
    </script>

    <style>
        /* Minimalist Black & White Theme Override */
        :root {
            --bg-color: #ffffff;
            --text-main: #000000;
            --border-color: #000000;
            --accent: #000000;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
        }

        /* Utilities */
        .btn-black {
            background-color: black;
            color: white;
            transition: all 0.2s;
        }
        .btn-black:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        .btn-outline {
            border: 2px solid black;
            color: black;
            font-weight: bold;
        }
        .input-std {
            border: 2px solid black;
            padding: 8px;
            outline: none;
            background: white;
            color: black;
            width: 100%;
        }
        .input-std:focus {
            background: #f0f0f0;
        }

        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: white; }
        ::-webkit-scrollbar-thumb { background: black; }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col max-w-md mx-auto w-full border-x-2 border-black bg-white shadow-2xl relative">

        <div v-if="loading" class="absolute inset-0 z-50 bg-white flex items-center justify-center">
            <div class="text-4xl font-black animate-pulse">WatchTower</div>
        </div>

        <div v-if="currentView === 'auth' && !loading" class="flex-1 flex flex-col justify-center p-8 space-y-6">
            <div class="text-center space-y-2">
                <i class="ph ph-lighthouse text-6xl"></i>
                <h1 class="text-4xl font-black tracking-tighter">WatchTower</h1>
                <p class="text-sm font-mono">Curate. Track. Share.</p>
            </div>
            
            <div class="space-y-3 pt-10">
                <button @click="loginGoogle" class="w-full btn-outline py-3 flex items-center justify-center gap-2 hover:bg-black hover:text-white transition">
                    <i class="ph ph-google-logo text-xl"></i> Continue with Google
                </button>
                <button @click="loginAnon" class="w-full btn-black py-3 font-bold">
                    Enter Anonymously
                </button>
            </div>
            
            <p class="text-xs text-center mt-8 border-t border-black pt-4">
                By entering, you agree to the WatchTower Protocol.
            </p>
        </div>

        <header v-if="user && currentView !== 'auth'" class="p-4 border-b-2 border-black flex justify-between items-center bg-white z-10">
            <h1 class="font-black text-xl tracking-tighter cursor-pointer" @click="currentView = 'home'">WT.</h1>
            <div class="flex gap-4 text-xl">
                <button @click="currentView = 'settings'"><i class="ph ph-gear"></i></button>
                <button @click="currentView = 'profile'"><i class="ph ph-user-circle"></i></button>
            </div>
        </header>

        <main v-if="user" class="flex-1 overflow-y-auto p-4 pb-24 relative">
            
            <div v-if="currentView === 'home'">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="border-2 border-black p-3 text-center cursor-pointer hover:bg-black hover:text-white transition"
                         :class="{'bg-black text-white': activeTab === 'towatch'}" @click="activeTab = 'towatch'">
                        <div class="text-2xl font-bold">{{ counts.towatch }}</div>
                        <div class="text-xs uppercase font-bold">To Watch</div>
                    </div>
                    <div class="border-2 border-black p-3 text-center cursor-pointer hover:bg-black hover:text-white transition"
                         :class="{'bg-black text-white': activeTab === 'watched'}" @click="activeTab = 'watched'">
                        <div class="text-2xl font-bold">{{ counts.watched }}</div>
                        <div class="text-xs uppercase font-bold">Consumed</div>
                    </div>
                </div>

                <div class="flex gap-2 mb-6">
                    <input v-model="newItem.title" @keyup.enter="addItem" type="text" placeholder="Add Series, Anime, Movie..." class="input-std">
                    <select v-model="newItem.type" class="border-2 border-black bg-white font-bold px-2">
                        <option>Series</option>
                        <option>Anime</option>
                        <option>Movie</option>
                        <option>Manga</option>
                    </select>
                    <button @click="addItem" class="btn-black px-4"><i class="ph ph-plus font-bold"></i></button>
                </div>

                <div class="space-y-3">
                    <div v-for="item in filteredList" :key="item.id" class="border-2 border-black p-3 flex justify-between items-center group hover:shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] transition-all">
                        <div>
                            <div class="font-bold text-lg leading-none">{{ item.title }}</div>
                            <span class="text-xs bg-black text-white px-1 mt-1 inline-block">{{ item.type }}</span>
                        </div>
                        <div class="flex gap-3">
                            <button @click="toggleStatus(item)" class="text-xl hover:scale-110">
                                <i :class="item.status === 'watched' ? 'ph-fill ph-check-circle' : 'ph ph-circle'"></i>
                            </button>
                            <button @click="deleteItem(item.id)" class="text-xl hover:text-red-600">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div v-if="filteredList.length === 0" class="text-center opacity-50 mt-10 italic">
                        Nothing here yet.
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'social'">
                <h2 class="font-black text-2xl mb-4">Transmission Feed</h2>
                
                <div class="mb-6 border-b-2 border-black pb-4">
                    <textarea v-model="newPost" placeholder="Suggest something to the world..." class="input-std h-20 mb-2 resize-none"></textarea>
                    <button @click="postSuggestion" class="btn-black w-full py-2 font-bold">Broadcast</button>
                </div>

                <div class="space-y-4">
                    <div v-for="post in socialPosts" :key="post.id" class="border-2 border-black p-4 bg-white relative">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-sm border-b border-black">{{ post.author }}</span>
                            <span class="text-xs opacity-60">{{ new Date(post.timestamp).toLocaleDateString() }}</span>
                        </div>
                        <p class="text-lg font-serif mb-3">{{ post.content }}</p>
                        <div class="flex items-center gap-2">
                            <button @click="likePost(post)" class="flex items-center gap-1 hover:opacity-70">
                                <i class="ph-fill ph-heart text-red-500" v-if="post.likes.includes(user.uid)"></i>
                                <i class="ph ph-heart" v-else></i>
                                <span class="font-bold text-sm">{{ post.likes ? post.likes.length : 0 }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'groups'">
                <h2 class="font-black text-2xl mb-4">Encrypted Cells</h2>
                
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div class="flex gap-2">
                        <input v-model="newGroupName" placeholder="New Group Name" class="input-std">
                        <button @click="createGroup" class="btn-black px-4 whitespace-nowrap">Create</button>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="groupJoinId" placeholder="Paste Group ID" class="input-std">
                        <button @click="joinGroup" class="btn-outline px-4 whitespace-nowrap">Join</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <div v-for="group in myGroups" :key="group.id" @click="enterGroup(group)" 
                         class="border-2 border-black p-4 cursor-pointer hover:bg-black hover:text-white transition flex justify-between">
                        <span class="font-bold">{{ group.name }}</span>
                        <i class="ph ph-caret-right"></i>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'chat_room'" class="h-full flex flex-col">
                <div class="border-b-2 border-black pb-2 mb-2 flex justify-between items-center">
                    <button @click="currentView = 'groups'" class="text-sm font-bold"><i class="ph ph-arrow-left"></i> Back</button>
                    <span class="font-bold">{{ activeGroup.name }}</span>
                    <button @click="() => { navigator.clipboard.writeText(activeGroup.id); alert('Group ID Copied'); }" class="text-xs border border-black px-2 py-1 rounded-full">Copy ID</button>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-3 mb-4 pr-1">
                    <div v-for="msg in groupMessages" :key="msg.id" :class="{'text-right': msg.uid === user.uid}">
                        <div class="inline-block max-w-[80%]">
                            <div class="text-[10px] font-bold opacity-70 mb-0.5">{{ msg.author }}</div>
                            <div class="border-2 border-black p-2 text-sm" 
                                 :class="msg.uid === user.uid ? 'bg-black text-white' : 'bg-white text-black'">
                                {{ msg.text }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 mt-auto">
                    <input v-model="newMessage" @keyup.enter="sendMessage" placeholder="Encrypted message..." class="input-std">
                    <button @click="sendMessage" class="btn-black px-4"><i class="ph ph-paper-plane-right"></i></button>
                </div>
            </div>

            <div v-if="currentView === 'profile'">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 bg-black text-white mx-auto rounded-full flex items-center justify-center text-4xl mb-4 border-4 border-white shadow-[0_0_0_2px_black]">
                        {{ user.displayName ? user.displayName[0].toUpperCase() : 'A' }}
                    </div>
                    <h2 class="text-2xl font-black">{{ user.displayName || 'Anonymous Agent' }}</h2>
                    <p class="text-sm font-mono opacity-60">ID: {{ user.uid.substring(0,8) }}...</p>
                </div>

                <div class="space-y-4">
                    <div class="border-2 border-black p-4 flex justify-between items-center">
                        <span class="font-bold">Total Items</span>
                        <span class="text-xl font-black">{{ myWatchlist.length }}</span>
                    </div>
                    
                    <button @click="copyProfileLink" class="w-full btn-outline py-3 flex items-center justify-center gap-2">
                        <i class="ph ph-share-network text-xl"></i> Share Public Link
                    </button>
                </div>
            </div>

            <div v-if="currentView === 'settings'">
                <h2 class="font-black text-2xl mb-6">System Config</h2>
                
                <div class="space-y-6">
                    <div>
                        <h3 class="font-bold mb-2 border-b border-black">Display</h3>
                        <label class="flex items-center justify-between py-2">
                            <span>Compact Mode</span>
                            <div class="w-4 h-4 border-2 border-black bg-black"></div>
                        </label>
                    </div>

                    <div>
                        <h3 class="font-bold mb-2 border-b border-black">Account</h3>
                        <div class="bg-gray-100 p-3 text-xs mb-4">
                            Currently logged in as: <br>
                            <strong>{{ user.email || 'Anonymous' }}</strong>
                        </div>
                        <button @click="logout" class="w-full btn-black py-3 font-bold border-2 border-black hover:bg-white hover:text-black transition">
                            Terminate Session
                        </button>
                    </div>

                    <div class="text-xs text-center opacity-50 mt-10">
                        WatchTower v1.0.0<br>
                        Secure Single-File Architecture
                    </div>
                </div>
            </div>

        </main>

        <nav v-if="user && currentView !== 'auth'" class="bg-white border-t-2 border-black grid grid-cols-4 h-16 shrink-0 z-20">
            <button @click="currentView = 'home'" :class="{'bg-black text-white': currentView === 'home'}" class="flex flex-col items-center justify-center transition hover:bg-gray-200">
                <i class="ph ph-list-dashes text-2xl"></i>
                <span class="text-[10px] font-bold uppercase mt-1">List</span>
            </button>
            <button @click="currentView = 'social'" :class="{'bg-black text-white': currentView === 'social'}" class="flex flex-col items-center justify-center transition hover:bg-gray-200">
                <i class="ph ph-globe text-2xl"></i>
                <span class="text-[10px] font-bold uppercase mt-1">Feed</span>
            </button>
            <button @click="currentView = 'groups'" :class="{'bg-black text-white': currentView === 'groups' || currentView === 'chat_room'}" class="flex flex-col items-center justify-center transition hover:bg-gray-200">
                <i class="ph ph-users-three text-2xl"></i>
                <span class="text-[10px] font-bold uppercase mt-1">Groups</span>
            </button>
            <button @click="currentView = 'profile'" :class="{'bg-black text-white': currentView === 'profile'}" class="flex flex-col items-center justify-center transition hover:bg-gray-200">
                <i class="ph ph-user text-2xl"></i>
                <span class="text-[10px] font-bold uppercase mt-1">ID</span>
            </button>
        </nav>

    </div>
</body>
</html>
